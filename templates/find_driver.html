{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>MedWheels ‚Äî Finding drivers</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <style>
         :root{ --bg:#f6f8fb; --card:#fff; --brand:#dc3545; --accent:#2b9f6b; --muted:#6c757d; --shadow: 0 6px 20px rgba(30,30,30,0.06); } *{box-sizing:border-box;margin:0;padding:0} body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#111;padding:20px} .layout{max-width:1200px;margin:18px auto;display:flex;gap:18px} .panel{width:420px;background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow)} h2{margin-bottom:12px;color:var(--brand)} .mapwrap{flex:1;height:640px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)} #map{width:100%;height:100%} .progress { height:6px;background:#eee;border-radius:6px;overflow:hidden;margin:12px 0 16px } .progress .bar { height:100%; width:0%; background:linear-gradient(90deg,var(--brand),#ff7a59); transition:width 400ms linear } .summary { padding:12px;border-radius:10px;background:#fafafa;border:1px solid #eee;margin-bottom:12px } .summary .line{display:flex;gap:12px;align-items:center} .summary .addr{font-weight:700} .fare { font-size:20px;font-weight:700;margin-top:8px } .note { color:var(--muted); font-size:13px;margin-top:8px } .cancel-btn { display:block;width:100%;padding:12px;border-radius:10px;border:1px solid #eee;background:#fff;color:var(--brand);font-weight:700;margin-top:14px;cursor:pointer } /* driver card */ .driver-card { display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px solid #eee } .driver-avatar { width:72px;height:72px;border-radius:50%;object-fit:cover;background:#f0f0f0;flex:0 0 72px } .driver-meta { flex:1 } .driver-meta .name { font-weight:800;font-size:18px } .driver-meta .vehicle { color:var(--muted);margin-top:6px } .small { font-size:13px;color:var(--muted) } .action-row { display:flex;gap:8px;margin-top:12px } .btn-primary { flex:1;padding:12px;border-radius:10px;background:var(--brand);color:#fff;border:0;cursor:pointer;font-weight:700 } .btn-ghost { flex:1;padding:12px;border-radius:10px;background:#fff;border:1px solid #ddd;cursor:pointer } /* pulse indicator (map) */ .pulse-dot { width:12px;height:12px;border-radius:50%;background:rgba(69,162,255,1);box-shadow:0 0 0 0 rgba(69,162,255,0.2); } /* small helper */ .muted { color:var(--muted) } /* modal */ .mw-modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:2000; } .mw-modal { width:90%; max-width:420px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.12); } .mw-modal h3{ margin-bottom:8px; color:var(--brand); } .mw-modal .content{ color:#333; margin-bottom:12px; } .mw-modal .actions{ display:flex; gap:8px; justify-content:flex-end; } .mw-btn { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:700 } .mw-btn.secondary{ background:#fff; border:1px solid #ddd; color:#333 } .mw-btn.primary{ background:var(--brand); color:#fff } /* responsive */ @media (max-width: 960px){ .layout{flex-direction:column} .panel{width:auto} .mapwrap{height:480px} }
    </style>
</head>
<body>
<div class="layout"> <!-- Left panel -->
    <div class="panel" id="left-panel"><h2 id="left-title">Finding available drivers</h2> <!-- Progress bar -->
        <div class="progress" aria-hidden="true">
            <div class="bar" id="match-progress"></div>
        </div> <!-- Summary (pickup -> drop) -->
        <div class="summary" id="summary-box">
            <div class="line">
                <div style="width:12px;height:12px;border-radius:50%;background:#2b9f6b"></div>
                <div>
                    <div class="addr" id="ui-pickup">Pickup address</div>
                    <div class="small" id="ui-pickup-sub">‚Äî</div>
                </div>
            </div>
            <div style="height:10px"></div>
            <div class="line">
                <div style="width:12px;height:12px;border-radius:3px;background:#000"></div>
                <div>
                    <div class="addr" id="ui-drop">Dropoff address</div>
                    <div class="small" id="ui-drop-sub">‚Äî</div>
                </div>
            </div>
            <div class="fare" id="ui-fare">‚Çπ ‚Äî</div> <!-- ETA countdown for closest vehicle while matching -->
            <div class="small" style="margin-top:8px">Closest vehicle ETA: <strong id="ui-closest-eta">‚Äî</strong></div>
            <div class="note">We'll share driver details shortly</div>
        </div> <!-- Buttons -->
        <button class="cancel-btn" id="cancel-matching-btn">Cancel ride</button>
        <div style="height:10px"></div>
        <div class="muted small">Note: you can cancel while matching.</div>
    </div> <!-- Map -->
    <div class="mapwrap">
        <div id="map"></div>
    </div>
</div> <!-- Assigned template (hidden; we'll replace left panel contents on assignment) -->
<template id="assigned-template"><h2>Driver on the way</h2>
    <div class="driver-card"><img class="driver-avatar" id="drv-photo" src="{% static 'img/default_driver.jpg' %}"
                                  alt="Driver">
        <div class="driver-meta">
            <div class="name" id="drv-name">Name</div>
            <div class="vehicle" id="drv-vehicle">WB00XX0000 ‚Ä¢ Ambulance</div>
            <div class="small" id="drv-eta">Arriving in 3 min</div>
        </div>
    </div>
    <div style="height:12px"></div>
    <div class="summary" id="assigned-summary">
        <div class="line">
            <div style="width:12px;height:12px;border-radius:50%;background:#2b9f6b"></div>
            <div style="margin-left:8px">
                <div class="addr" id="ui-pickup-assigned">Pickup address</div>
                <div class="small" id="ui-pickup-sub-assigned">‚Äî</div>
            </div>
        </div>
        <div style="height:10px"></div>
        <div class="line">
            <div style="width:12px;height:12px;border-radius:3px;background:#000"></div>
            <div style="margin-left:8px">
                <div class="addr" id="ui-drop-assigned">Dropoff address</div>
                <div class="small" id="ui-drop-sub-assigned">‚Äî</div>
            </div>
        </div>
        <div class="fare" id="ui-fare-assigned">‚Çπ ‚Äî</div>
    </div>
    <div class="action-row">
        <button class="btn-ghost" id="contact-driver-btn">Contact</button>
        <button class="btn-primary" id="cancel-assigned-btn">Cancel ride</button>
    </div>
</template> <!-- No-drivers modal -->
<div class="mw-modal-overlay" id="no-drivers-modal" role="dialog" aria-hidden="true">
    <div class="mw-modal" role="document" aria-labelledby="no-drivers-title"><h3 id="no-drivers-title">No ambulances
        found nearby</h3>
        <div class="content" id="no-drivers-msg">We couldn't find nearby ambulances within the search radius. You can
            retry or try again later.
        </div>
        <div class="actions">
            <button class="mw-btn secondary" id="no-drivers-close">Close</button>
            <button class="mw-btn primary" id="no-drivers-retry">Retry (widen radius)</button>
        </div>
    </div>
</div> <!-- Cancel confirm modal -->
<div class="mw-modal-overlay" id="cancel-confirm-modal" role="dialog" aria-hidden="true">
    <div class="mw-modal" role="document" aria-labelledby="cancel-confirm-title"><h3 id="cancel-confirm-title">Cancel
        ride?</h3>
        <div class="content" id="cancel-confirm-msg">Are you sure you want to cancel this ride? You may be charged a
            cancellation fee.
        </div>
        <div class="actions">
            <button class="mw-btn secondary" id="cancel-confirm-no">No</button>
            <button class="mw-btn primary" id="cancel-confirm-yes">Yes, cancel</button>
        </div>
    </div>
</div> <!-- Cancel result modal -->
<div class="mw-modal-overlay" id="cancel-result-modal" role="dialog" aria-hidden="true">
    <div class="mw-modal" role="document" aria-labelledby="cancel-result-title"><h3 id="cancel-result-title">Ride
        cancelled</h3>
        <div class="content" id="cancel-result-msg">Your ride has been cancelled.</div>
        <div class="actions">
            <button class="mw-btn primary" id="cancel-result-ok">OK</button>
        </div>
    </div>
</div>
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
<script>
/* -----------------------------------------------
   üîê CSRF TOKEN HELPER
----------------------------------------------- */
const csrftoken = (function () {
  const v = document.cookie.match('(^|;)\\s*' + 'csrftoken' + '\\s*=\\s*([^;]+)');
  return v ? decodeURIComponent(v.pop()) : '';
})();

/* -----------------------------------------------
   üåç MAP SETUP & GLOBALS
----------------------------------------------- */
let map, directionsService, directionsRenderer;
let pickupMarker = null, dropMarker = null;
let driverMarker = null;
let nearbyMarkers = {}; // id -> marker
let pickupCircle = null;
let pulseInterval = null;

const DEFAULT_CENTER = {
  lat: {{ DEFAULT_MAP_CENTER.0|default:22.5726 }},
  lng: {{ DEFAULT_MAP_CENTER.1|default:88.3639 }}
};
const DEFAULT_ZOOM = 13;

let progressInterval = null, progressStartTs = null;
const MATCH_TIMEOUT_MS = 60 * 1000, MATCH_PROGRESS_TICK_MS = 1000;

let nearbyPollTimer = null;
const NEARBY_POLL_MS = 7000;
const NEARBY_URL = new URL("{% url 'api_nearby_ambulances' %}", window.location.origin);

const INITIAL_SEARCH_RADIUS_M = 5000, MAX_SEARCH_RADIUS_M = 50000, RADIUS_GROW_FACTOR = 2;
let currentSearchRadius = INITIAL_SEARCH_RADIUS_M;

let etaTimer = null, closestEtaSec = null;
const AVG_SPEED_KMPH = 25.0;

let ROUTE_BOUNDS = null, MAP_CYCLE_INTERVAL = null, MAP_CYCLE_MS = 6000, mapCycleIndex = 0;

/* -----------------------------------------------
   üó∫Ô∏è MAP INITIALIZATION
----------------------------------------------- */
function initMapFindDriver() {
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
  map = new google.maps.Map(document.getElementById('map'), {
    center: DEFAULT_CENTER,
    zoom: DEFAULT_ZOOM,
    streetViewControl: false
  });
  directionsRenderer.setMap(map);
}

/* -----------------------------------------------
   üìç MARKERS (Pickup / Drop / Driver)
----------------------------------------------- */
function setPickupMarker(latlng) {
  if (!pickupMarker) {
    pickupMarker = new google.maps.Marker({
      position: latlng,
      map,
      title: 'Pickup',
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: '#2b9f6b',
        fillOpacity: 1,
        strokeWeight: 2,
        strokeColor: '#fff'
      }
    });
  } else pickupMarker.setPosition(latlng);
  map.panTo(latlng);
}

function setDropMarker(latlng) {
  if (!dropMarker) {
    dropMarker = new google.maps.Marker({
      position: latlng,
      map,
      title: 'Dropoff',
      icon: {
        path: 'M12 2C8.7 2 6 4.7 6 8c0 3.9 5.7 10.5 5.9 10.8.1.1.3.1.4 0C12.3 18.5 18 12 18 8c0-3.3-2.7-6-6-6z',
        fillColor: '#ff7a59',
        fillOpacity: 1,
        strokeWeight: 0,
        scale: 1.4,
        anchor: new google.maps.Point(12, 24)
      }
    });
  } else dropMarker.setPosition(latlng);
}

function updateDriverLocation(lat, lng, title) {
  if (!driverMarker) {
    const icon = { url: "{% static 'car.png' %}", scaledSize: new google.maps.Size(44, 44) };
    driverMarker = new google.maps.Marker({
      position: { lat, lng },
      map,
      title: title || 'Driver',
      icon
    });
  } else {
    if (title) driverMarker.setTitle(title);
    const start = driverMarker.getPosition();
    const fromLat = start.lat(), fromLng = start.lng();
    const duration = 1200, t0 = performance.now();
    function step(now) {
      const t = Math.min(1, (now - t0) / duration);
      const latn = fromLat + (lat - fromLat) * t;
      const lngn = fromLng + (lng - fromLng) * t;
      driverMarker.setPosition({ lat: latn, lng: lngn });
      if (t < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }
}

/* -----------------------------------------------
   üí° ANIMATIONS (Pulse + Route)
----------------------------------------------- */
function startPulseAt(latlng) {
  stopPulse();
  pickupCircle = new google.maps.Circle({
    map,
    center: latlng,
    radius: 10,
    strokeColor: '#2b9f6b',
    strokeOpacity: 0.35,
    strokeWeight: 1,
    fillColor: '#2b9f6b',
    fillOpacity: 0.12
  });
  let grow = 10, dir = 1;
  pulseInterval = setInterval(() => {
    grow += dir * 6;
    if (grow > 200) dir = -1;
    if (grow < 10) dir = 1;
    pickupCircle.setRadius(grow);
    const o = Math.max(0.05, 0.3 * (1 - grow / 220));
    pickupCircle.setOptions({ fillOpacity: o, strokeOpacity: o * 1.2 });
  }, 350);
}
function stopPulse() {
  if (pulseInterval) clearInterval(pulseInterval);
  if (pickupCircle) pickupCircle.setMap(null);
  pulseInterval = null; pickupCircle = null;
}

function drawRoute(originLatLng, destLatLng) {
  if (!originLatLng || !destLatLng) return;
  directionsService.route({
    origin: originLatLng, destination: destLatLng, travelMode: 'DRIVING'
  }, (res, status) => {
    if (status === 'OK') {
      directionsRenderer.setDirections(res);
      setPickupMarker(originLatLng);
      setDropMarker(destLatLng);
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(originLatLng); bounds.extend(destLatLng);
      try {
        const route = res.routes && res.routes[0];
        if (route && route.overview_path)
          for (const p of route.overview_path) bounds.extend(p);
      } catch (e) {}
      map.fitBounds(bounds);
      if (map.getZoom() > 16) map.setZoom(16);
      ROUTE_BOUNDS = bounds;
    } else ROUTE_BOUNDS = null;
  });
}

/* -----------------------------------------------
   ‚è±Ô∏è ETA + DISTANCE HELPERS
----------------------------------------------- */
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const toRad = (x) => (x * Math.PI) / 180;
  const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function formatEta(min) {
  if (!min || min <= 0) return 'Arriving soon';
  if (min === 1) return 'Arriving in 1 min';
  return `Arriving in ${min} mins`;
}

/* -----------------------------------------------
   üß† STATE VARIABLES
----------------------------------------------- */
let CURRENT_RIDE = null;
let SOCKET = null;

/* -----------------------------------------------
   üöò ON DRIVER ASSIGNED ‚Äî Auto Switch Panel
----------------------------------------------- */
function onDriverAssigned(driverObj) {
  stopPulse(); stopProgressBar(); stopMatchingPolling(); clearNearbyMarkers(); stopEtaCountdown();
  currentSearchRadius = INITIAL_SEARCH_RADIUS_M;

  const tpl = document.getElementById('assigned-template');
  const left = document.getElementById('left-panel');
  if (left) { left.innerHTML = ''; left.appendChild(tpl.content.cloneNode(true)); }

  const drvPhoto = document.getElementById('drv-photo');
  if (drvPhoto) drvPhoto.src = driverObj.photo_url || '{% static "img/default_driver.jpg" %}';
  document.getElementById('drv-name').textContent = driverObj.name || 'Driver';
  document.getElementById('drv-vehicle').textContent =
    (driverObj.vehicle_no || '') + (driverObj.vehicle_type ? (' ‚Ä¢ ' + driverObj.vehicle_type) : '');
  document.getElementById('drv-eta').textContent = formatEta(driverObj.eta_min);
  const fareAssigned = document.getElementById('ui-fare-assigned');
  if (fareAssigned && driverObj.fare) fareAssigned.textContent = '‚Çπ ' + Number(driverObj.fare).toFixed(2);

  setSummaryUI(CURRENT_RIDE.pickup, CURRENT_RIDE.drop, CURRENT_RIDE.fare);

  const cancelAssignedBtn = document.getElementById('cancel-assigned-btn');
  if (cancelAssignedBtn) cancelAssignedBtn.addEventListener('click', () => openCancelConfirm(CURRENT_RIDE.id));

  if (driverObj.lat && driverObj.lng)
    updateDriverLocation(Number(driverObj.lat), Number(driverObj.lng), driverObj.name || 'Driver');

  if (driverObj.lat && driverObj.lng)
    drawRoute({ lat: Number(driverObj.lat), lng: Number(driverObj.lng) },
              { lat: Number(CURRENT_RIDE.pickup.lat), lng: Number(CURRENT_RIDE.pickup.lng) });
  else if (CURRENT_RIDE.drop)
    drawRoute({ lat: Number(CURRENT_RIDE.pickup.lat), lng: Number(CURRENT_RIDE.pickup.lng) },
              { lat: Number(CURRENT_RIDE.drop.lat), lng: Number(CURRENT_RIDE.drop.lng) });
}

/* -----------------------------------------------
   üì° DRIVER LOCATION UPDATES (live ETA)
----------------------------------------------- */
function onDriverLocationUpdate(loc) {
  updateDriverLocation(Number(loc.lat), Number(loc.lng));
  const distKm = haversineDistance(Number(loc.lat), Number(loc.lng),
    Number(CURRENT_RIDE.pickup.lat), Number(CURRENT_RIDE.pickup.lng));
  const eta = Math.round((distKm / AVG_SPEED_KMPH) * 60);
  const etaEl = document.getElementById('drv-eta');
  if (etaEl) etaEl.textContent = formatEta(eta);
}

/* -----------------------------------------------
   üîå WEBSOCKET CONNECTION (real-time events)
----------------------------------------------- */
function connectRideSocket(rideId) {
  if (!rideId) return null;
  if (SOCKET) { SOCKET.close(); SOCKET = null; }

  const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const url = `${scheme}://${window.location.host}/ws/ride/${rideId}/`;
  SOCKET = new WebSocket(url);

  SOCKET.onopen = () => console.log('ride socket open', url);
  SOCKET.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);
      if (data.type === 'ride.assigned') onDriverAssigned(data.driver || {});
      else if (data.type === 'location.update') onDriverLocationUpdate(data);
      else if (data.type === 'ride.matching_failed') onMatchingFailed();
      else if (data.type === 'ride.cancelled')
        openCancelResult('Ride cancelled by driver/system.', true);
      else console.log('ride socket msg', data);
    } catch (e) { console.warn('socket parse error', e); }
  };
  SOCKET.onclose = () => console.log('ride socket closed');
  SOCKET.onerror = (err) => console.error('ride socket error', err);
  return SOCKET;
}

/* -----------------------------------------------
   üß≠ INITIALIZATION
----------------------------------------------- */
initMapFindDriver();

(function () {
  try {
    const RIDE = {{ ride_json|safe }};
    if (RIDE) {
      const pickup = {
        lat: RIDE.pickup.lat, lng: RIDE.pickup.lng,
        address: RIDE.pickup.address, short: ''
      };
      const drop = RIDE.drop ? {
        lat: RIDE.drop.lat, lng: RIDE.drop.lng,
        address: RIDE.drop.address, short: ''
      } : null;
      CURRENT_RIDE = { id: RIDE.ride_id, pickup, drop, fare: RIDE.fare };
      connectRideSocket(RIDE.ride_id);

      // ‚úÖ Automatically switch panel if driver already assigned
      if (RIDE.status === 'assigned' && RIDE.driver) {
        console.log('Already assigned ‚Äî showing driver panel');
        onDriverAssigned(RIDE.driver);
      } else {
        console.log('Starting matching mode');
        setTimeout(() => startMatching(RIDE.ride_id, pickup, drop, RIDE.fare), 300);
      }
    }
  } catch (e) { console.warn('no initial ride payload or parse error', e); }
})();
</script>

</body>

</html>
