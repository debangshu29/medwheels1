{% load static %}
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MedWheels — Driver dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --brand:#dc3545; --accent:#2b9f6b; --muted:#6c757d;
    --shadow: 0 6px 20px rgba(30,30,30,0.06);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#111}
  .layout{max-width:1200px;margin:18px auto;display:flex;gap:18px}
  .sidebar{width:240px;background:var(--card);border-radius:8px;padding:12px;position:fixed;top:12px;bottom:12px}
  .sidebar h2{color:var(--brand);margin-bottom:12px}
  .nav-links{list-style:none;padding:0}
  .nav-links li{margin:8px 0}
  .nav-links a{display:block;padding:10px;border-radius:8px;color:#222;text-decoration:none}
  .nav-links a.active{background:#f0f4ff;color:var(--brand)}
  .topbar{margin-left:260px;height:60px;background:var(--card);display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-radius:8px}
  .main{margin-left:260px;padding:20px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:12px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:#fff;border:1px solid #eee}
  .tab.active{background:#f0f4ff;color:var(--brand);border-color:transparent}
  .small{font-size:13px;color:var(--muted)}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn-accept{background:var(--accent);color:#fff}
  .btn-reject{background:var(--brand);color:#fff}
  .requests-list{display:flex;flex-direction:column;gap:8px}
  .request-item{padding:10px;border-radius:8px;border:1px solid #eee;background:#fff}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <aside class="sidebar" role="navigation">
    <h2>MedWheels</h2>
    <ul class="nav-links" id="left-nav">
      <li><a href="#" data-page="dashboard" class="nav-link">Dashboard</a></li>
      <li><a href="#" data-page="profile" class="nav-link">Profile</a></li>
      <li><a href="#" data-page="requests" class="nav-link">New Requests</a></li>
      <li><a href="#" data-page="history" class="nav-link">Ride History</a></li>
      <li><a href="#" data-page="payments" class="nav-link">Payments</a></li>
      <li><a href="{% url 'driver_logout' %}" id="logout-link">Logout</a></li>
    </ul>
  </aside>

  <div class="topbar" role="banner" style="margin-left:260px;">
    <div><strong id="page-title">Driver Dashboard</strong></div>
    <div style="display:flex;gap:12px;align-items:center">
      <div class="small">Signed in as <strong>{{ driver.full_name }}</strong></div>
      <img src="{{ driver.user.profile_picture|default:'https://cdn-icons-png.flaticon.com/512/149/149071.png' }}" alt="avatar" width="40" height="40" style="border-radius:50%;object-fit:cover" />
    </div>
  </div>

  <main class="main" id="main-content" role="main">
    <!-- Tabs placed here to switch main content -->
    <div class="tabs" role="tablist" aria-label="Driver tabs">
      <div class="tab" data-tab="dashboard" id="tab-dashboard">Dashboard</div>
      <div class="tab" data-tab="profile" id="tab-profile">Profile</div>
      <div class="tab" data-tab="requests" id="tab-requests">Requests</div>
    </div>

    <div id="tab-contents">
      <!-- DASHBOARD CONTENT -->
      <div class="card" data-content="dashboard" id="content-dashboard" style="display:none">
        <h3>Live location sharing</h3>
        <p class="small">Allow the browser to share your location. Keep this page open to continue sharing.</p>
        <div style="margin-top:8px;">
          <button id="btn-start" class="btn btn-accept">Start Sharing Location</button>
          <button id="btn-stop" class="btn btn-reject" style="margin-left:8px">Stop Sharing</button>
          <span id="liveStatus" style="margin-left:12px;color:#666;"></span>
        </div>
        <div style="margin-top:12px;">
          <div id="curPos">No position yet.</div>
          <div id="sendLog" style="margin-top:8px;color:#666;font-size:0.9rem;"></div>
        </div>

        <div style="height:12px"></div>

        <div>
          <h4>New incoming requests</h4>
          <div id="incoming-requests" class="requests-list">
            <!-- new requests will be inserted here by WS -->
            <div class="muted">No requests yet.</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div>
          <h4>Previous requests</h4>
          <div id="previous-requests" class="requests-list">
            <!-- small client-side placeholder; server population will come later -->
            <div class="muted">No history yet.</div>
          </div>
        </div>
      </div>

      <!-- PROFILE CONTENT -->
      <div class="card" data-content="profile" id="content-profile" style="display:none">
        <h3>Profile</h3>
        <div style="display:flex;gap:16px;align-items:flex-start">
          <img src="{{ driver.user.profile_picture|default:'https://cdn-icons-png.flaticon.com/512/149/149071.png' }}" width="120" height="120" style="border-radius:8px;object-fit:cover"/>
          <div>
            <p><strong>Name:</strong> {{ driver.full_name }}</p>
            <p><strong>Email:</strong> {{ driver.user.email }}</p>
            <p><strong>Phone:</strong> {{ driver.user.phone_number }}</p>
            <p><strong>Address:</strong> {{ driver.address }}</p>
            <p><strong>Experience:</strong> {{ driver.experience }}</p>
          </div>
        </div>
      </div>

      <!-- REQUESTS CONTENT (detailed list) -->
      <div class="card" data-content="requests" id="content-requests" style="display:none">
        <h3>Requests</h3>
        <div id="requests-list-detailed" class="requests-list">
          <div class="muted">No requests yet.</div>
        </div>
      </div>

    </div>
  </main>

  <!-- Pass initial live state from server to JS -->
  {% if live %}
    {{ live|json_script:"init_driver_live" }}
    <script>try{ window.INIT_DRIVER_LIVE = JSON.parse(document.getElementById('init_driver_live').textContent); }catch(e){window.INIT_DRIVER_LIVE=null}</script>
  {% else %}
    <script>window.INIT_DRIVER_LIVE = null;</script>
  {% endif %}

<script>
(function(){
  // helper: CSRF token
  function getCookie(name){ const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return match ? decodeURIComponent(match.pop()) : ''; }
  const csrftoken = getCookie('csrftoken');

  // Tab switching
  const tabs = document.querySelectorAll('.tab');
  const navLinks = document.querySelectorAll('.nav-link');
  const contents = document.querySelectorAll('[data-content]');

  function showTab(name){
    contents.forEach(c=> c.style.display = (c.getAttribute('data-content')===name ? 'block' : 'none'));
    tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
    navLinks.forEach(n=> n.classList.toggle('active', n.dataset.page===name));
    // update page-title
    const title = document.getElementById('page-title');
    if(title) title.textContent = name.charAt(0).toUpperCase()+name.slice(1) + ' — Driver Dashboard';
  }

  // wire nav left links to tabs
  navLinks.forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const p = a.dataset.page;
      showTab(p);
    });
  });

  // wire small top tabs
  tabs.forEach(t=> t.addEventListener('click', ()=> showTab(t.dataset.tab)));

  // Default to 'dashboard'
  showTab('dashboard');

  // ——— Live-sharing logic (same as before but now in dashboard)
  const btnStart = document.getElementById('btn-start');
  const btnStop = document.getElementById('btn-stop');
  const curPos = document.getElementById('curPos');
  const liveStatus = document.getElementById('liveStatus');
  const sendLog = document.getElementById('sendLog');

  let watchId = null, lastSentAt=0;
  const MIN_SEND_MS = 5000;
  let lastLat=null, lastLng=null;

  async function sendLocation(lat,lng,isOnline=true){
    if(lat==null || lng==null){
      if(lastLat==null || lastLng==null) return;
      lat = lastLat; lng = lastLng;
    }
    const payload = { lat: lat, lng: lng, is_online: Boolean(isOnline) };
    try{
      const res = await fetch("{% url 'api_driver_live_update' %}", {
        method:'POST', credentials:'same-origin',
        headers:{ 'Content-Type':'application/json','X-CSRFToken': csrftoken },
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok && j.ok){
        const t = new Date().toLocaleTimeString();
        liveStatus.textContent = `Last sent: ${t} (online: ${isOnline ? 'yes' : 'no'})`;
        sendLog.textContent = `Server response at ${t}`;
      } else {
        liveStatus.textContent = 'Send failed';
        sendLog.textContent = 'Server error: ' + (j && j.error ? j.error : res.status);
      }
    }catch(err){
      liveStatus.textContent = 'Send error';
      sendLog.textContent = 'Network error';
      console.error('sendLocation', err);
    }
  }

  function onPosition(position){
    lastLat = position.coords.latitude;
    lastLng = position.coords.longitude;
    curPos.textContent = `Latitude: ${lastLat.toFixed(6)}, Longitude: ${lastLng.toFixed(6)}`;
    const now = Date.now();
    if(now - lastSentAt < MIN_SEND_MS) return;
    lastSentAt = now;
    sendLocation(lastLat,lastLng,true);
  }
  function onPosError(err){
    console.warn('geolocation error', err);
    curPos.textContent = 'Geolocation error: ' + (err.message || err.code);
  }

  btnStart.addEventListener('click', (e)=>{
    e.preventDefault();
    if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
    if(watchId !== null){ alert('Already sharing location'); return; }
    navigator.geolocation.getCurrentPosition(function(p){ onPosition(p); }, onPosError, { enableHighAccuracy:true, timeout:10000 });
    watchId = navigator.geolocation.watchPosition(onPosition, onPosError, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
    btnStart.disabled = true; btnStop.disabled = false; liveStatus.textContent = 'Sharing…';
    if(lastLat !== null && lastLng !== null) sendLocation(lastLat,lastLng,true);
  });

  btnStop.addEventListener('click', (e)=>{
    e.preventDefault();
    if(watchId !== null){ navigator.geolocation.clearWatch(watchId); watchId = null; }
    btnStart.disabled = false; btnStop.disabled = true; liveStatus.textContent = 'Not sharing';
    // final offline ping
    const data = JSON.stringify({ lat: lastLat, lng: lastLng, is_online:false });
    try {
      if(navigator.sendBeacon){
        navigator.sendBeacon("{% url 'api_driver_live_update' %}", data);
      } else {
        fetch("{% url 'api_driver_live_update' %}", { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken}, body: data });
      }
    } catch(e){ /* best effort */ }
  });

  // On page unload: send final offline ping
  window.addEventListener('beforeunload', function(){
    if(watchId !== null){ try{ navigator.geolocation.clearWatch(watchId); } catch(e){} watchId = null; }
    if(lastLat !== null && lastLng !== null){
      const data = JSON.stringify({ lat: lastLat, lng: lastLng, is_online:false });
      try {
        if(navigator.sendBeacon){
          navigator.sendBeacon("{% url 'api_driver_live_update' %}", data);
        } else {
          // fire-and-forget fallback (do not block)
          fetch("{% url 'api_driver_live_update' %}", { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken}, body: data }).catch(()=>{});
        }
      } catch(e){}
    }
  });

  // Intercept logout link to send offline ping before leaving
  const logoutLink = document.getElementById('logout-link');
  if(logoutLink){
    logoutLink.addEventListener('click', function(e){
      // send a quick offline ping and then allow navigation
      e.preventDefault();
      const href = logoutLink.href;
      const data = JSON.stringify({ lat: lastLat, lng: lastLng, is_online:false });
      try {
        if(navigator.sendBeacon){
          navigator.sendBeacon("{% url 'api_driver_live_update' %}", data);
          // give browser a tiny moment to do beacon (beacon does not delay navigation)
          window.location.href = href;
        } else {
          // synchronous fallback: POST then navigate (fast)
          fetch("{% url 'api_driver_live_update' %}", { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken}, body: data }).finally(()=> { window.location.href = href; });
        }
      } catch(err){ window.location.href = href; }
    });
  }

  // Driver WebSocket for incoming requests
  try {
    const DRIVER_ID = {{ driver.id|default:'null' }};
    if(DRIVER_ID){
      const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
      const url = `${scheme}://${window.location.host}/ws/driver/${DRIVER_ID}/`;
      let ws = new WebSocket(url);
      ws.onopen = ()=> console.log('driver ws open');
      ws.onmessage = (ev)=>{
        try {
          const msg = JSON.parse(ev.data);
          if(msg.type === 'ride.request' || (msg.data && msg.data.type === 'ride.request')){
            const r = msg.data || msg;
            showIncomingRequest(r);
          } else if(msg.type === 'location.update'){
            // could update current live info UI
            if(msg.last_seen) document.getElementById('sendLog').textContent = 'Driver last_seen: ' + msg.last_seen;
          } else if(msg.type === 'driver.assignment_confirmed'){
            // move to Requests or update UI
          } else {
            console.log('driver ws msg', msg);
          }
        } catch(e){ console.warn('ws parse error', e); }
      };
      ws.onclose = ()=> console.log('driver ws closed');
      window._driver_ws = ws;
    }
  } catch(e){ console.error(e); }

  // helper to display incoming request in dashboard list (and add to previous)
  function showIncomingRequest(r){
    const container = document.getElementById('incoming-requests');
    if(!container) return;
    container.innerHTML = ''; // show latest most prominently (you can change)
    const el = document.createElement('div');
    el.className = 'request-item';
    const pickup = r.pickup || r.pickup_address || 'Unknown pickup';
    const drop = r.dropoff || r.dropoff_address || '';
    el.innerHTML = `<div><strong>Pickup:</strong> ${pickup}</div>
                    <div class="small"><strong>Drop:</strong> ${drop}</div>
                    <div style="margin-top:8px"><button class="btn btn-accept" onclick="respondToRequest(${r.ride_id}, 'accept')">Accept</button>
                    <button class="btn btn-reject" onclick="respondToRequest(${r.ride_id}, 'reject')" style="margin-left:8px">Reject</button></div>`;
    container.appendChild(el);

    // also add to previous requests (history) UI with default state "pending"
    addPreviousRequest({ id: r.ride_id, pickup, drop, state: 'pending' });
  }

  window.respondToRequest = async function(ride_id, action){
    try {
      const res = await fetch("{% url 'api_driver_respond' %}", {
        method:'POST', credentials:'same-origin',
        headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ ride_id: ride_id, action: action })
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok && j.ok){
        // update previous requests UI
        updatePreviousRequestState(ride_id, action === 'accept' ? 'accepted' : 'rejected');
        // clear incoming request area
        const container = document.getElementById('incoming-requests');
        if(container) container.innerHTML = '<div class="muted">No requests right now.</div>';
      } else {
        alert('Request respond failed: ' + (j.error || 'server error'));
      }
    } catch(err){ console.error(err); alert('Network error'); }
  };

  function addPreviousRequest(req){
    const list = document.getElementById('previous-requests');
    if(!list) return;
    // simple row
    const row = document.createElement('div');
    row.className = 'request-item';
    row.id = 'prev-req-' + req.id;
    row.innerHTML = `<div><strong>${req.pickup}</strong></div><div class="small">${req.drop || ''}</div><div class="small">Status: <span class="req-state">${req.state}</span></div>`;
    // insert newest at top
    if(list.firstChild && list.firstChild.classList && list.firstChild.classList.contains('muted')){
      list.innerHTML = ''; // clear placeholder
    }
    list.insertBefore(row, list.firstChild);
  }
  function updatePreviousRequestState(ride_id, newState){
    const el = document.getElementById('prev-req-' + ride_id);
    if(el){
      const span = el.querySelector('.req-state');
      if(span) span.textContent = newState;
    }
    // also add to detailed requests list
    const dlist = document.getElementById('requests-list-detailed');
    if(dlist && dlist.firstChild && dlist.firstChild.classList && dlist.firstChild.classList.contains('muted')){
      dlist.innerHTML = '';
    }
    const row = document.createElement('div');
    row.className = 'request-item';
    row.innerHTML = `<div>Ride ${ride_id} — ${newState}</div>`;
    dlist.insertBefore(row, dlist.firstChild);
  }

  // initialize UI from server-provided live object
  (function initFromServer(){
    document.getElementById('btn-stop').disabled = true;
    if(window.INIT_DRIVER_LIVE){
      const init = window.INIT_DRIVER_LIVE;
      const el = document.getElementById('initLiveInfo');
      // we no longer show it on profile; but if needed, you can update curPos or sendLog
      if(init.last_seen) sendLog.textContent = 'Initial live last_seen: ' + init.last_seen;
    }
  })();

  // replace login history entry: trigger a history.replace (best-effort) to avoid login appearing when user presses back.
  // Note: we also modify driver_login view server-side to use location.replace to avoid adding login to history.
  try{ history.replaceState(null, '', window.location.href); }catch(e){}

})();
</script>
</body>
</html>
