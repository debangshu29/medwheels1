{% load static %}
<script>
  const PLACEHOLDER_IMG = "{% static 'img/placeholder.png' %}";
  const DOC_PLACEHOLDER_IMG = "{% static 'img/doc-placeholder.png' %}";
</script>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MedWheels — CEO Panel: Pending Drivers</title>
  <link rel="stylesheet" href="{% static 'css/admin-common.css' %}" />
  <style>
    :root { --brand:#dc3545; --accent:#76df8e; --bg:#fff; --chip:#f6f8ff; --muted:#666; }
    body{font-family:Inter,Segoe UI,Helvetica,Arial; margin:0;background:#f4f6f8;color:#222}
    .wrap{max-width:1100px;margin:28px auto;padding:18px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    header h1{font-size:20px;color:var(--brand);margin:0}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .panel{background:var(--bg);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .list-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;cursor:pointer}
    .list-item:hover{background:var(--chip)}
    .avatar{width:56px;height:56px;border-radius:8px;object-fit:cover}
    .name{font-weight:600}
    .status{font-size:12px;color:var(--muted)}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-approve{background:var(--accent);color:#fff}
    .btn-reject{background:var(--brand);color:#fff}
    .empty{padding:18px;color:var(--muted);text-align:center}
    /* details */
    .details-row{display:flex;gap:10px;margin-bottom:8px}
    .details-row b{width:140px;color:var(--muted);font-weight:600}
    .doc-thumb{width:120px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #eee}
    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:60}
    .modal .card{width:820px;max-width:96%;padding:18px;border-radius:10px;background:var(--bg)}
    .modal .card header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal .card .actions{display:flex;gap:8px}
    .small-muted{font-size:13px;color:var(--muted)}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} .list-item{gap:10px} .details-row b{width:120px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>CEO Panel — Pending Drivers</h1>
      <div>
        <span class="small-muted">Signed in as</span>
        <strong>{{ request.session.user_name|default:"Admin" }}</strong>
        &nbsp;·&nbsp;
        <a href="{% url 'logout' %}">Logout</a>
      </div>
    </header>

    <div class="grid">
      <!-- left: pending list -->
      <div class="panel" id="leftPanel">
        <h3 style="margin:0 0 10px 0">Pending Applications</h3>
        <div id="pendingList">
          <div class="empty">Loading…</div>
        </div>
      </div>

      <!-- right: details / bulk actions -->
      <div class="panel" id="rightPanel">
        <h3 style="margin:0 0 10px 0">Driver Details</h3>
        <div id="emptyDetails" class="empty">Select a pending application to see details</div>

        <div id="driverDetails" style="display:none">
          <div class="details-row"><b>Full name</b><div id="d_fullname"></div></div>
          <div class="details-row"><b>Phone</b><div id="d_phone"></div></div>
          <div class="details-row"><b>Email</b><div id="d_email"></div></div>
          <div class="details-row"><b>Experience</b><div id="d_experience"></div></div>
          <div class="details-row"><b>Gender</b><div id="d_gender"></div></div>
          <div class="details-row"><b>Address</b><div id="d_address"></div></div>

          <div class="details-row"><b>License No</b><div id="d_license"></div></div>
          <div class="details-row"><b>Vehicle</b><div id="d_vehicle"></div></div>
          <div class="details-row"><b>Applied on</b><div id="d_created"></div></div>

          <hr style="margin:12px 0">

          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <div>
              <div style="font-size:13px;color:#666;margin-bottom:6px">Photo</div>
              <a id="d_photo_link" target="_blank"><img id="d_photo" class="doc-thumb" src="{% static 'img/placeholder.png' %}"></a>
            </div>
            <div>
              <div style="font-size:13px;color:#666;margin-bottom:6px">License (scan)</div>
              <a id="d_license_link" target="_blank"><img id="d_license_img" class="doc-thumb" src="{% static 'img/doc-placeholder.png' %}"></a>
            </div>
            <div>
              <div style="font-size:13px;color:#666;margin-bottom:6px">Gov ID</div>
              <a id="d_govid_link" target="_blank"><img id="d_govid_img" class="doc-thumb" src="{% static 'img/doc-placeholder.png' %}"></a>
            </div>
          </div>

          <div style="margin-top:16px;display:flex;gap:10px">
            <button class="btn btn-approve" id="approveBtn">Approve</button>
            <button class="btn btn-reject" id="rejectBtn">Reject</button>
            <button class="btn" id="refreshBtn">Refresh list</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm/Reason modal -->
  <div id="confirmModal" class="modal">
    <div class="card">
      <header><strong id="confirmTitle">Confirm</strong><button onclick="closeConfirm()" class="btn">✕</button></header>
      <div>
        <p id="confirmText">Are you sure?</p>
        <div id="reasonBlock" style="display:none;margin-top:8px">
          <label>Reason (optional)</label>
          <input id="rejectReason" type="text" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd">
        </div>
      </div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn" onclick="closeConfirm()">Cancel</button>
        <button class="btn btn-reject" id="confirmRejectBtn" style="display:none">Confirm Reject</button>
        <button class="btn btn-approve" id="confirmApproveBtn" style="display:none">Confirm Approve</button>
      </div>
    </div>
  </div>

<script>
/* --- API URLs (from Django url names) --- */
const API_PENDING = "{% url 'admin_pending_drivers' %}";
const API_APPROVE  = "{% url 'admin_approve_driver' %}";
const API_REJECT   = "{% url 'admin_reject_driver' %}";

/* CSRF helper */
function getCookie(name) {
  let v = null;
  if (document.cookie && document.cookie !== '') {
    const c = document.cookie.split(';');
    for (let i=0;i<c.length;i++) {
      const cookie = c[i].trim();
      if (cookie.substring(0, name.length+1) === (name + '=')) { v = decodeURIComponent(cookie.substring(name.length+1)); break; }
    }
  }
  return v;
}
const csrftoken = getCookie('csrftoken');

/* UI elements */
const pendingListEl = document.getElementById('pendingList');
const emptyDetails = document.getElementById('emptyDetails');
const detailsEl = document.getElementById('driverDetails');

let currentDriver = null;    // full driver object from API
let currentDriverId = null;

function showLoadingList(){
  pendingListEl.innerHTML = '<div class="empty">Loading…</div>';
}

/* Fetch pending drivers and render left column */
async function loadPending() {
  showLoadingList();
  try {
    const res = await fetch(API_PENDING, { credentials: 'same-origin' });
    if (!res.ok) throw new Error('Fetch failed');
    const json = await res.json();
    const list = json.pending || [];
    renderPending(list);
  } catch(err){
    pendingListEl.innerHTML = '<div class="empty">Failed to load pending list</div>';
    console.error(err);
  }
}

function renderPending(list){
  if (!list.length) {
    pendingListEl.innerHTML = '<div class="empty">No pending driver applications</div>';
    return;
  }
  pendingListEl.innerHTML = '';

  list.forEach(d => {
    // compute a safe, human-friendly created-at string
    const createdAt = d.created_at ? (isNaN(new Date(d.created_at)) ? '' : new Date(d.created_at).toLocaleString()) : '';

    const row = document.createElement('div');
    row.className = 'list-item';
    row.dataset.driverId = d.id;

    const photoSrc = (d.media && d.media.photo_url) ? d.media.photo_url : PLACEHOLDER_IMG;

    row.innerHTML = `
      <img class="avatar" src="${photoSrc}" alt="">
      <div style="flex:1">
        <div class="name">${escapeHtml(d.full_name)}</div>
        <div class="status">${escapeHtml(d.license_no || d.status || '')}</div>
      </div>
      <div style="min-width:80px;text-align:right"><small class="small-muted">${createdAt}</small></div>
    `;
    row.addEventListener('click', ()=> openDetails(d));
    pendingListEl.appendChild(row);
  });
}


/* show details on right pane */
function openDetails(d){
  currentDriver = d; currentDriverId = d.id;
  emptyDetails.style.display = 'none';
  detailsEl.style.display = 'block';

  document.getElementById('d_fullname').innerText = d.full_name || '';
  document.getElementById('d_phone').innerText = d.phone || '';
  document.getElementById('d_email').innerText = d.email || '';
  document.getElementById('d_experience').innerText = d.experience ?? 0;
  document.getElementById('d_gender').innerText = d.gender || '';
  document.getElementById('d_address').innerText = d.address || '';

  document.getElementById('d_license').innerText = d.license_no || '';
  document.getElementById('d_vehicle').innerText = d.vehicle || '';
  document.getElementById('d_created').innerText = d.created_at ? new Date(d.created_at).toLocaleString() : '';

  // docs
  const photo = d.media.photo_url || '';
  const lic = d.media.license_scan_url || '';
  const gov = d.media.gov_id_url || '';

  const elPhoto = document.getElementById('d_photo');
  const elPhotoLink = document.getElementById('d_photo_link');
  elPhoto.src = photo || PLACEHOLDER_IMG;
  elPhotoLink.href = photo || '#';

  const elLic = document.getElementById('d_license_img');
  const elLicLink = document.getElementById('d_license_link');
  elLic.src = lic || DOC_PLACEHOLDER_IMG;
  elLicLink.href = lic || '#';

  const elGov = document.getElementById('d_govid_img');
  const elGovLink = document.getElementById('d_govid_link');
  elGov.src = gov || DOC_PLACEHOLDER_IMG;
  elGovLink.href = gov || '#';
}

/* approve/reject - open confirm modal first */
const confirmModal = document.getElementById('confirmModal');
const confirmText = document.getElementById('confirmText');
const confirmTitle = document.getElementById('confirmTitle');
const reasonBlock = document.getElementById('reasonBlock');
const confirmApproveBtn = document.getElementById('confirmApproveBtn');
const confirmRejectBtn = document.getElementById('confirmRejectBtn');

document.getElementById('approveBtn').addEventListener('click', ()=> openConfirm('approve'));
document.getElementById('rejectBtn').addEventListener('click', ()=> openConfirm('reject'));
document.getElementById('refreshBtn').addEventListener('click', ()=> loadPending());

function openConfirm(mode){
  if (!currentDriverId) { alert('Select a driver first'); return; }
  confirmModal.style.display = 'flex';
  reasonBlock.style.display = (mode==='reject') ? 'block' : 'none';
  confirmText.innerText = mode==='approve' ? `Approve ${currentDriver.full_name}? This will set status to approved.` : `Reject ${currentDriver.full_name}? Provide reason (optional).`;
  confirmTitle.innerText = mode==='approve' ? 'Confirm Approve' : 'Confirm Reject';
  confirmApproveBtn.style.display = mode==='approve' ? 'inline-block' : 'none';
  confirmRejectBtn.style.display = mode==='reject' ? 'inline-block' : 'none';
  confirmApproveBtn.onclick = doApprove;
  confirmRejectBtn.onclick = doReject;
}

function closeConfirm(){
  confirmModal.style.display = 'none';
  document.getElementById('rejectReason').value = '';
}

/* perform approve */
async function doApprove(){
  if (!currentDriverId) return;
  confirmApproveBtn.disabled = true;
  try {
    const res = await fetch(API_APPROVE, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json','X-CSRFToken':csrftoken},
      body: JSON.stringify({driver_id: currentDriverId})
    });
    const j = await res.json();
    if (res.ok && j.ok) {
      alert('Driver approved');
      await loadPending();
      closeConfirm();
      // clear details pane
      detailsEl.style.display='none'; emptyDetails.style.display='block'; currentDriver = null; currentDriverId=null;
    } else {
      alert('Approve failed: ' + (j.error || JSON.stringify(j)));
    }
  } catch (err) {
    console.error(err); alert('Approve failed');
  } finally { confirmApproveBtn.disabled = false; }
}

/* perform reject */
async function doReject(){
  if (!currentDriverId) return;
  const reason = document.getElementById('rejectReason').value || '';
  confirmRejectBtn.disabled = true;
  try {
    const res = await fetch(API_REJECT, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json','X-CSRFToken':csrftoken},
      body: JSON.stringify({driver_id: currentDriverId, reason})
    });
    const j = await res.json();
    if (res.ok && j.ok) {
      alert('Driver rejected');
      await loadPending();
      closeConfirm();
      detailsEl.style.display='none'; emptyDetails.style.display='block'; currentDriver=null; currentDriverId=null;
    } else {
      alert('Reject failed: ' + (j.error || JSON.stringify(j)));
    }
  } catch (err) {
    console.error(err); alert('Reject failed');
  } finally { confirmRejectBtn.disabled = false; }
}

/* util: escape text for safety */
function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

/* close the modal when clicking outside */
confirmModal.addEventListener('click', (e)=> { if (e.target === confirmModal) closeConfirm(); });

/* initial load */
document.addEventListener('DOMContentLoaded', ()=> loadPending());
</script>
</body>
</html>
